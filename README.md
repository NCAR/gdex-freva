# GDEX Freva Deployment

[Freva](https://freva-org.github.io) is a data search and analsys platform
which is deployed on Cirrus at NCAR.

This repository provides an initial test setup for deploying Freva on the NCAR
Kubernetes environment. It serves as a proof of concept to explore and refine
the future deployment approach.

---

## Repository Structure

All Kubernetes manifests are located in the `freva/` directory. Note that the
current secrets have been automatically generated. This is a temporary
solution; a more robust secret management approach will be introduced later.

---

## Setup of the Core Library on Casper

The current design requires either the
[freva-legacy](https://freva-org.github.io/freva-legacy) installation to run
analysis plugins or, if plugins are disabled, the configuration files required
for the web application. To set up the legacy plugin library (core) and/or
configure the web app, use the [deploy-freva](https://freva-admin.readthedocs.io) software.

### 1. Log in to Casper

```console
ssh <username>@casper.hpc.ucar.edu
```

### 2. Clone the Repository

```console
git clone git@github.com:NCAR/gdex-freva.git
```

### 3. Install the Deployment Software

```console
python -m pip install --user -U freva-deployment
```

> [!NOTE]
> Ensure that the `core.root_dir` entry in `freva-ncar.toml` points to the
> correct location. Also verify that `core.root_dir` is a relative path under
> the `mount_path` and `driver_options.path` entries in
> `kubernetes.external_volumes.web-ext`.

### 4. Run the Deployment

```console
deploy-freva cmd -c freva-ncar.toml -l --skip-version-check \
    -t core pre-web -g
```

To create only the web configuration:

```console
deploy-freva cmd -c freva-ncar.toml -l --skip-version-check \
    -t pre-web -g
cp nsf-logo.png <core.root_dir>/freva/web
```

This process sets up an Anaconda environment for the legacy library (if `core`
was chosen) and generates the web configuration files.

### Configuration Files

- `<core.root_dir>/freva/evaluation_system.conf`
  Configures plugin locations, workload manager settings, and is used by the
  web app.
- `<core.root_dir>/freva/web/freva_web_conf.toml`
  Web application configuration file.

After completion, copy the `drs-config.toml` file into `<core.root_dir>/freva/`.
This file will be used later for metadata collection.

---

## Manifest Generation and Application

The Kubernetes manifests are auto-generated by the [deploy-freva] software.
This approach ensures that configuration remains synchronized with the latest
developments in the framework.

### 1. Clone or Update the Repository

```console
git clone git@github.com:NCAR/gdex-freva.git
```

If already cloned:

```console
git pull origin main
```

### 2. Install or Update the Deployment Software

```console
python -m pip install --user -U freva-deployment
```

> [!NOTE]
> You may need to add `~/.local/bin` to your PATH.

### 3. Generate the Manifests

In the `gdex-freva` directory, run:

```console
deploy-freva kubernetes -c freva-ncar.toml -o freva
```

You will be prompted to enter a **master password**. This is the only password
not auto-generated and must be chosen carefully. It serves as both the MySQL
root password and the Django admin password. Use the same **master password**
consistently across deployments and share it only with other administrators.

### 4. Apply the Manifests

```console
kubectl apply -f freva
```

If errors occur, apply the manifests one by one:

```console
for f in $(ls freva/*.yaml); do kubectl apply -f "$f"; sleep 2;done
```

### Secrets

Except for the **master password**, all other credentials are auto-generated.
Apply the `freva/01-secrets.yaml` file only once.

> [!IMPORTANT]
> Keep the generated `freva/01-secrets.yaml` file stored securely outside of
> Git.

---

## Metadata Indexing

Metadata indexing is performed using the [metadata-crawler] software. This
Python package can be installed via Conda or pip.

```console
mamba install -c conda-forge metadata-crawler
```

or

```console
python -m pip install metadata-crawler
```

After installation, you can (re)index metadata with:

```console
mdc add <path-to>/index.yaml -c drs-config.toml
```

This command crawls metadata and creates an Intake (YAML) catalog. Once
created, index the data in Solr:

```console
mdc solr index <path-to>/index.yaml -sv freva-solr.k8s.ucar.edu
```

For more information on the software and DRS configuration specifications, see
the [metadata-crawler documentation](https://metadata-crawler.readthedocs.io/chapter2-config/index.html)

---

## References

- [freva-legacy](https://freva-org.github.io/freva-legacy)
- [deploy-freva](https://freva-admin.readthedocs.io)
- [metadata-crawler](https://metadata-crawler.readthedocs.io)
- [metadata-crawler documentation](https://metadata-crawler.readthedocs.io/chapter2-config/index.html)
