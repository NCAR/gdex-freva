# GDEX Freva Deployment
This repository contains an initial test setup for deploying Freva on the
NCAR Kubernetes environment.
It serves as a proof of concept to explore and refine the future deployment
approach.


## Repository Structure
All Kubernetes manifests are located in the `freva/` directory.
Note that the current secrets have been auto-generated. This is a
temporary solution, and a more robust secret management approach will be
introduced later.

### Secrets
Secerts are generated by ansible to semi automate the creation and
maintenance of Kubernetes secrets for the Freva instance.

In order to generate secrets you must install the python requirements.

```console
python3 -m pip install -r playbooks/requirements.txt
```

It will:

1. Verify required fields in your vaulted secrets file (ADMIN_PASSWORD is mandatory).
1. Allow an empty OIDC_CLIENT_SECRET (for public OIDC clients).
1. Mirror MYSQL_ROOT_PASSWORD = ADMIN_PASSWORD.
1. Generate random usernames and passwords for any missing services.
1. Persist those values back to the encrypted Ansible Vault file.
1. Create or patch the Kubernetes Secret, adding any missing keys but never
   overwriting existing ones.


The `vars.yml` contains the main configuration in plain YML k8s matadata.
You usually only touch `k8s_namespace` and `k8s_secret_name`.

The `secrets.yml.vault` file holds only secrets you must supply manually, such
as `ADMIN_PASSWORD` (must be set) or  `OIDC_CLIENT_SECRET` (can be left empty).


The `secrects.yml.vault` is encrypted using ansible vault. The password for
encryption has to be added to the `playbooks/vault-pass.txt` file.

Once the password has been added to `playbook/vault-pass.txt` you'll be able to
generate the k8s secrets using the following command:

```console
ansible-playbook playbooks/set-secrets.yml --vault-password-file playbooks/vault-pass.txt
```

> [!IMPORTANT]
> Keep the generated `playbooks/build/freva-secrets.yml` file or the
> vault passwords outside Git; Make sure the secrets.yml.vault file
> is encrypted when being checked in to Git;
