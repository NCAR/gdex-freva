---
apiVersion: batch/v1
kind: Job
metadata: { name: web-prep, namespace: freva }
spec:
  template:
    metadata: { labels: { app: web-prep } }
    spec:
      restartPolicy: OnFailure
      containers:
        - name: curl-writer
          image: quay.io/curl/curl:latest
          env:
            - { name: VAR1_B64, value: "W2V2YWx1YXRpb25fc3lzdGVtXQojIEZyZXZhIC0gRnJlZSBFdmFsdWF0aW9uIFN5c3RlbSBGcmFtZXdvcmsgY29uZmlndXJhdGlvbiBmaWxlCiMgVGhpcyBmaWxlIGNvbnRhaW5zIHRoZSBuZWNlc3NhcnkgY29uZmlndXJhdGlvbiBpbmZvcm1hdGlvbgojIHdoaWNoIGlzIG5lZWRlZCB0byBydW4gZnJldmEKIwojIFVzZXJuYW1lKHMpIC0gY29tbWEgc2VwYXJhdGVkIC0gb2YgdGhlIGFkbWlucyBvZiB0aGUgcHJvamVjdAphZG1pbnM9azIwNDIzMCxiMzgwMDAxCiMKIyBBbiBJbmZvcm1hdGl2ZSBwcm9qZWN0IG5hbWUKcHJvamVjdF9uYW1lPWZyZXZhCiMgVGhlIHVybCB0aGUgZnJldmEgd2ViIHVpIGNhbiBiZSBhY2Nlc3NlZCB3aXRoCnByb2plY3Rfd2Vic2l0ZT13d3cuZnJldmEtZGVsb3B5bWVudC5jbG91ZC5ka3J6LmRlCgojIE1haW4gY29uZmlndXJhdGlvbiBwYXRoIG9mIHRoZSBmcmV2YSBpbnN0YW5jZSBkZWZhdWx0IHRvIHRoZSBldGMgZGlyCiMgb2YgdGhlIHB5dGhvbiBlbnZpcm9ubWVudApyb290X2Rpcj0vaG9tZS9rL2syMDQyMzAvZnJldmEtY29yZQojCiMKCiM6IFR5cGUgb2YgZGlyZWN0b3J5IHN0cnVjdHVyZSB0aGF0IHdpbGwgYmUgdXNlZCB0byBtYWludGFpbiBzdGF0ZToKIzoKIzogICAgbG9jYWwgICA6PSA8aG9tZT4vPGJhc2VfZGlyPi4uLgojOiAgICBjZW50cmFsIDo9IDxiYXNlX2Rpcl9sb2NhdGlvbj4vPHVzZXJuYW1lPi88YmFzZV9kaXI+Li4uCiM6CmRpcmVjdG9yeV9zdHJ1Y3R1cmVfdHlwZT1jZW50cmFsCgojIFRoZSBsb2NhdGlvbiBvZiB0aGUgd29yayBkaXJlY3RvcnkgZm9yIGlzIHVzZXIgc3BlY2lmaWMgZGF0YQojIFRoaXMgc2V0dGluZyB3aWxsIGhhdmUgbm8gZWZmZWN0IGlmIHlvdSBoYXZlIHNldCB0aGUgYGRpcmVjdG9yeV9zdHJ1Y3R1cmVfdHlwZWAKIyB0byBjZW50cmFsCmJhc2VfZGlyX2xvY2F0aW9uPS9ob21lL2svazIwNDIzMC9mcmV2YS1jb3JlL3dvcmsKCiMgVGhlIGRpcmVjdG9yeSBuYW1lIG9mIHRoZSA8YmFzZV9kaXI+IChvbmx5IHVzZWQgaWYgYGRpcmVjdG9yeV9zdHJ1Y3R1cmVfdHlwZWAKIyBpcyBzZXQgdG8gY2VudHJhbCAtIGRlZmF1bHRzIHRvIGBwcm9qZWN0X25hbWVgCmJhc2VfZGlyPSR7cHJvamVjdF9uYW1lfQoKIyBXb3JrbG9hZCBtYW5hZ2VyIGNvbmZpZ3VyYXRpb24KIyBXb3JrbG9hZCBtYW5hZ2VyIHN5c3RlbSAtIGN1cnJlbnRseSB0aGUgZm9sbG93aW5nIHdvcmtsb2FkIG1hbmdlciBzeXN0ZW1zIGFyZQojIGF2YWlsYWJsZTogbG9jYWwgKG5vIHdvcmtsb2FkIG1hbmFnZXIpLCBsc2YsIG1vYWIsIG9hciwgcGJzLCBzZ2UsIHNsdXJtCnNjaGVkdWxlcl9zeXN0ZW09cGJzCiMgVGhlIGRpcmVjdG9yeSB3aGVyZSB0ZW1wb3Jhcnkgam9iIHNjcmlwdHMgYXJlIGNyZWF0ZWQKc2NoZWR1bGVyX2lucHV0X2Rpcj0vdG1wLyR7c2NoZWR1bGVyX3N5c3RlbX1fb3V0cHV0CiMgVGhlIG91dHB1dCBkaXJlY3Rvcnkgd2hlcmUgc3Rkb3VyL3N0ZGVyciBvZiB0aGUgam9icyBhcmUgc3RvcmVkCnNjaGVkdWxlcl9vdXRwdXRfZGlyPS9ob21lL2svazIwNDIzMC9mcmV2YS1jb3JlL3dvcmsvc2hhcmUvcGJzCgojIFRoZSBkaXJlY3RvcnkgZGF0YSB3aGVyZSBwcmV2aWV3IGRhdGEgKGltYWdlcyBldGMpIGZvciB0aGUgd2ViIHVpCiMgaXMgc3RvcmVkLgpwcmV2aWV3X3BhdGg9L2hvbWUvay9rMjA0MjMwL2ZyZXZhLWNvcmUvd29yay9zaGFyZS9wcmV2aWV3CiMgVGhlIG51bWJlciBvZiBwcm9jZXNzZXMgdXNlZCB0byBjb252ZXJ0IGltYWdlcyBjcmVhdGVkIGJ5IHBsdWdpbnMKIyBmb3IgZGlzcGxheSBpbiB0aGUgd2ViIHVpLgpudW1iZXJfb2ZfcHJvY2Vzc2VzPTYKCiM6IFBhdGggdG8gdGhlIGRpcmVjdG9yeSB3aGVyZSB1c2VycyBjYW4gYWRkIGFuIHNoYXJlIHByb2plY3Qgc3BlY2lmaWMgZGF0YQpwcm9qZWN0X2RhdGE9JHtiYXNlX2Rpcl9sb2NhdGlvbn0vZGF0YS9jcmF3bF9teV9kYXRhCgojOiBkYXRhYmFzZSBwYXRoCgojOiBteVNRTCBzZXR0aW5ncwpkYi5ob3N0PWxvY2FsaG9zdAoKI2dyb3VwIGZvciBleHRlcm5hbCB1c2VycwojZXh0ZXJuYWxfZ3JvdXA9ZnJldmFleHQKCiM6IERlZmluZSBhY2Nlc3MgdG8gdGhlIHNvbHIgaW5zdGFuY2UKc29sci5ob3N0PWxvY2FsaG9zdApzb2xyLnBvcnQ9ODk4Mwpzb2xyLmNvcmU9ZmlsZXMKCiNzaGVsbGluYWJveAojc2hlbGxtYWNoaW5lPU5vbmUKI3NoZWxscG9ydD00MjAwCgojIFdvcmtsb2FkIG1hbmFnZXIgam9iIGNvbmZpZ3VyYXRpb24KIyBOT1RFOiBUaGUgb3B0aW9ucyBhcmUgd29ya2xvYWQgbWFuYWdlciBhZ25vc3RpYyAtIGV4Y2VwdCBvZiB0aGUKIyBleHRyYV9vcHRpb25zIGZsYWc6IHdoaWNoIG11c3QgYmUgaW4gYWNjb3JkYW5jZSB0byB0aGUgdXRpbGl6ZWQKIyB3b3JrbG9hZCBtYW5hZ2VyLgpbc2NoZWR1bGVyX29wdGlvbnNdCiNtZW1vcnk9MjU2R2lCCiNxdWV1ZT1ncHUKI3Byb2plY3Q9dGVzdAojd2FsbHRpbWU9MDg6MDA6MDAKI2NwdXM9MTIKIyNBZGRpdGlvbmFsIG9wdGlvbnMgKHNwZWNpZmljIHRvIHRoZSB3b3JrbG9hZCBtYW5hZ2VyKQojZXh0cmFfb3B0aW9ucz0tLXFvcz10ZXN0LCAtLWFycmF5PTIwCgojW3BsdWdpbjphbmltYXRvcl0KI3B5dGhvbl9wYXRoPSR7ZXZhbHVhdGlvbl9zeXN0ZW06cm9vdF9kaXJ9L3BsdWdpbnMvYW5pbWF0b3IKI21vZHVsZT1hbmltYXRvcgo=" }
            - { name: VAR2_B64, value: "aW5zdGl0dXRpb25fbG9nbyA9ICIgIgptYWluX2NvbG9yID0gIiNmMjk2MzEiCmJvcmRlcl9jb2xvciA9ICIjYmM4MDAwIgpob3Zlcl9jb2xvciA9ICIjZDQ4YjNkIgpob21lcGFnZV90ZXh0ID0gIldlbGNvbWUgdG8gVkFTS0VCSk9STiBDbGltYXRlIEFuYWx5dGljcywgd2hlcmUgZGF0YSBtZWV0cyBpbnNpZ2h0IHRvIGRyaXZlIHN1c3RhaW5hYmxlIHNvbHV0aW9ucyBmb3IgYSBncmVlbmVyIGZ1dHVyZS4gT3VyIGN1dHRpbmctZWRnZSBhbmFseXRpY3MgcGxhdGZvcm0gZW1wb3dlcnMgeW91IHdpdGggcmVhbC10aW1lIGluZm9ybWF0aW9uIHRvIHVuZGVyc3RhbmQgYW5kIGFkZHJlc3MgdGhlIGNoYWxsZW5nZXMgcG9zZWQgYnkgY2xpbWF0ZSBjaGFuZ2UuIERpdmUgaW50byB0aGUgd29ybGQgb2YgVmFza2Viam9ybiBhbmQgZXhwbG9yZSB0aGUgZHVtbXkgdGV4dCBiZWxvdyB0byBnZXQgYSBnbGltcHNlIG9mIHRoZSBpbXBhY3RmdWwgbmFycmF0aXZlcyB3ZSB3ZWF2ZS4iCmltcHJpbnQgPSBbIkZyZXZhIiwgIkdlcm1hbiBDbGltYXRlIENvbXB1dGluZyBDZW50cmUgKERLUlopIiwgIkJ1bmRlc3N0ci4gNDVhIiwgIjIwMTQ2IEhhbWJ1cmciLCAiR2VybWFueSJdCmhvbWVwYWdlX2hlYWRpbmcgPSAiVkFTS0VCSk9STiAtIFZpc2lvbmFyeSBBbmFseXRpY3MgZm9yIFN1c3RhaW5hYmxlIEtub3dsZWRnZSBFbnZpcm9ubWVudCAtIEJ1aWxkaW5nIEp1c3QgT3V0Y29tZXMgd2l0aCBSZXNpbGllbnQgTmV0d29ya3MiCmFib3V0X3VzX3RleHQgPSAiVGhpcyBjb3VsZCBiZSB5b3Vycy4iCmNvbnRhY3RzID0gImZyZXZhQGRrcnouZGUiCmluc2l0dXRpb25fbmFtZSA9ICIiCm1lbnVfZW50cmllcyA9IFsKICAgIFsiRGF0YS1Ccm93c2VyIiwgInNvbHI6ZGF0YV9icm93c2VyIiwgImJyb3dzZXJfbWVudSJdLAogICAgWyJQbHVnaW5zIiwgInBsdWdpbnM6aG9tZSIsICJwbHVnaW5fbWVudSJdLAogICAgWyJIaXN0b3J5IiwgImhpc3Rvcnk6aGlzdG9yeSIsICJoaXN0b3J5X21lbnUiXSwKICAgIFsiUmVzdWx0LUJyb3dzZXIiLCAiaGlzdG9yeTpyZXN1bHRfYnJvd3NlciIsICJyZXN1bHRfYnJvd3Nlcl9tZW51Il0sCiAgICBbIkhlbHAiLCAicGx1Z2luczphYm91dCIsICJkb2NfbWVudSJdCl0K" }
            - { name: FREVA_CONFIG, value: "/config" }
          volumeMounts:
            - { name: web-config, mountPath: /config }
          command:
            - sh
            - -c
            - curl -Ssl https://raw.githubusercontent.com/freva-org/freva-admin/refs/heads/main/assets/share/freva/deployment/scripts/write-config.sh | sh
      volumes:
        - name: web-config
          persistentVolumeClaim: { claimName: web-config }
